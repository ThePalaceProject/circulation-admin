name: Test & Publish Next

on:
  # The build will be triggered on push to main
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

concurrency:
  group: test-build-${{ github.ref_name }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  test-and-tag:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install Node.js ðŸ’»
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Set up Python ðŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Dunamai ðŸª„
        run: pip install -r requirements-ci.txt

      - name: Install locked dependencies ðŸ”§
        run: npm ci

      - name: Version âœ…
        run: npm version --no-git-tag-version $(dunamai from git --style semver)

      - name: Test ðŸ§ª
        env:
          TZ: America/New_York
        run: npm test

      - name: Upgrade npm for OIDC support ðŸ“¦
        # Upgrade npm to support OIDC trusted publishing. Earlier steps run with the
        # npm version bundled with current Node version to maintain consistency with
        # the development environment. Only the Publish step requires the newer version.
        # See https://docs.npmjs.com/trusted-publishers
        # > Note: Trusted publishing requires npm CLI version 11.5.1 or later.
        # TODO: This can be removed once we upgrade to Node 24 or greater.
        run: npm install -g npm@^11.5.1

      - name: Publish ðŸ“š
        run: npm publish --tag next --access public
